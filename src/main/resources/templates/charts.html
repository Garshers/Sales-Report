<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Sales Charts</title>
    <link rel="stylesheet" type="text/css" href="/css/chartsStyle.css">
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <h1>Sales Charts</h1>

    <!-- Accumulated Sales Chart -->
    <div class="chart-container">
        <div class="button-container">
            <button onclick="sortChartData('accumulatedSalesChart', 'asc')">Sort by Smallest</button>
            <button onclick="sortChartData('accumulatedSalesChart', 'desc')">Sort by Largest</button>
        </div>
        <canvas id="accumulatedSalesChart"></canvas>
    </div>

    <!-- Sales Person Chart -->
    <div class="chart-container">
        <div class="button-container">
            <button onclick="sortChartData('salesPersonChart', 'asc')">Sort by Smallest</button>
            <button onclick="sortChartData('salesPersonChart', 'desc')">Sort by Largest</button>
        </div>
        <canvas id="salesPersonChart"></canvas>
    </div>

    <a href="/sales">Go to sales page</a>

    <script th:inline="javascript">
        // Object to store all charts for easy management
        const charts = {};
    
        // Universal function to create a chart
        function createChart(chartId, labels, dataValues, labelText, type, options = {}) {
            const ctx = document.getElementById(chartId).getContext('2d');

            // If the chart already exists, destroy it to avoid errors
            if (charts[chartId]) {
                charts[chartId].destroy();
            }

            // Default chart options
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) {
                                return tooltipItem.raw + ' USD'; // Format tooltips to show values
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            };

            // Set colors depending on chart type
            let backgroundColor, borderColor;

            if (type === 'pie') {
                backgroundColor = [
                    'rgba(135, 206, 235, 0.2)',
                    'rgba(144, 238, 144, 0.2)',
                    'rgba(255, 228, 196, 0.2)',
                    'rgba(211, 211, 211, 0.2)',
                    'rgba(255, 239, 189, 0.2)' 
                ];
                borderColor = 'rgba(75, 192, 192, 1)';
            } else if (type === 'bar') {
                backgroundColor = 'rgba(75, 192, 192, 0.2)';
                borderColor = 'rgba(75, 192, 192, 1)';
            }

            // Merge default options with the provided options
            options = Object.assign({}, defaultOptions, options);

            // Create and save the new chart in the `charts` object
            charts[chartId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: dataValues,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: options
            });

            return charts[chartId];
        }
    
        // Universal function to sort chart data
        function sortChartData(chartId, sortType) {
            // Get the chart by `chartId`
            const chart = charts[chartId];
            if (!chart) return;
    
            // Copy chart data
            const labels = chart.data.labels.slice();
            const dataValues = chart.data.datasets[0].data.slice();
    
            // Sort data based on `sortType`
            const sortedData = labels.map((label, index) => ({
                label: label,
                data: dataValues[index]
            }));
    
            if (sortType === 'asc') {
                sortedData.sort((a, b) => a.data - b.data);
            } else if (sortType === 'desc') {
                sortedData.sort((a, b) => b.data - a.data);
            }
    
            // Update chart data
            chart.data.labels = sortedData.map(item => item.label);
            chart.data.datasets[0].data = sortedData.map(item => item.data);
    
            // Refresh the chart
            chart.update();
        }
    
        // Initialize charts when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Data for charts
            const salesLabels = /*[[${chartData.labels}]]*/ [];
            const salesDataValues = /*[[${chartData.values}]]*/ [];
    
            const salesPersonLabels = /*[[${salesPersonProfits.keySet()}]]*/ [];
            const salesPersonDataValues = /*[[${salesPersonProfits.values()}]]*/ [];
    
            // Initialize charts
            createChart('accumulatedSalesChart', salesLabels, salesDataValues, 'Total Sales', 'bar');
            createChart('salesPersonChart', salesPersonLabels, salesPersonDataValues, 'Total Profits', 'pie');
        });
    </script>
</body>
</html>